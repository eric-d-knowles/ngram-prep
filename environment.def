Bootstrap: docker
From: nvidia/cuda:12.6.2-cudnn-devel-ubuntu22.04

%setup
    # ----------------------------------------------------------------------
    # Torch HPC auto-binds these host directories during %post. They MUST
    # exist inside the container rootfs during build or Apptainer fails with:
    #   mount /path -> /path: destination does not exist in container
    # ----------------------------------------------------------------------
    mkdir -p "${APPTAINER_ROOTFS}/scratch"
    mkdir -p "${APPTAINER_ROOTFS}/home"
    mkdir -p "${APPTAINER_ROOTFS}/projects"
    mkdir -p "${APPTAINER_ROOTFS}/share/apps"
    mkdir -p "${APPTAINER_ROOTFS}/state/partition1"

%post
    set -e
    export DEBIAN_FRONTEND=noninteractive

    # ----------------------------------------------------------------------
    # System packages
    # ----------------------------------------------------------------------
    apt-get update
    apt-get install -y --no-install-recommends \
        wget \
        git \
        libenchant-2-2 \
        hunspell-en-us \
        hunspell-de-de \
        hunspell-es \
        hunspell-fr \
        hunspell-it \
        hunspell-ru

    rm -rf /var/lib/apt/lists/*

    # ----------------------------------------------------------------------
    # Install Miniforge (conda-forge). Mambaforge is deprecated.
    # Pin to a known-good stable version.
    # ----------------------------------------------------------------------
    wget https://github.com/conda-forge/miniforge/releases/download/24.7.1-0/Miniforge3-Linux-x86_64.sh \
        -O /tmp/miniforge.sh

    bash /tmp/miniforge.sh -b -p /opt/miniforge
    rm /tmp/miniforge.sh

    # Use strict channel priority for reproducibility
    /opt/miniforge/bin/conda config --system --set channel_priority strict

    # ----------------------------------------------------------------------
    # Install Python packages with conda (fast and reliable)
    # ----------------------------------------------------------------------
    /opt/miniforge/bin/conda install -y -n base -c conda-forge \
        python=3.11 \
        "numpy>=1.20" \
        "scipy>=1.7" \
        "pandas>=1.3" \
        "matplotlib>=3.5" \
        "seaborn>=0.11" \
        "Cython>=3.0" \
        "ipykernel>=6.0" \
        "jupyter_client>=7.0" \
        "nbformat>=5.0" \
        "notebook>=6.4" \
        "stop-words>=2018.7.23" \
        "spacy>=3.0" \
        "setproctitle>=1.3" \
        "tqdm>=4.64" \
        "gensim>=4.0" \
        "scikit-learn>=1.0" \
        "statsmodels>=0.13" \
        "lz4>=4.0"

    # ----------------------------------------------------------------------
    # Additional pip-only packages
    # ----------------------------------------------------------------------
    /opt/miniforge/bin/pip install --no-cache-dir \
        "simplemma>=0.9" \
        "spacy-lookups-data>=1.0" \
        "pyenchant>=3.2"

    # ----------------------------------------------------------------------
    # spaCy model downloads
    # ----------------------------------------------------------------------
    for model in \
        en_core_web_sm \
        zh_core_web_sm \
        fr_core_news_sm \
        de_core_news_sm \
        it_core_news_sm \
        ru_core_news_sm \
        es_core_news_sm
    do
        /opt/miniforge/bin/python -m spacy download "$model"
    done

    # ----------------------------------------------------------------------
    # Information checks (optional)
    # ----------------------------------------------------------------------
    /opt/miniforge/bin/python -c "import spacy; print('spaCy:', spacy.__version__)"
    /opt/miniforge/bin/python -c "from stop_words import AVAILABLE_LANGUAGES; print('stop_words:', sorted(AVAILABLE_LANGUAGES))"
    /opt/miniforge/bin/python -c "import simplemma; print('simplemma:', simplemma.__version__)"

    # ----------------------------------------------------------------------
    # rocks_shim (high-speed RocksDB interface)
    # ----------------------------------------------------------------------
    /opt/miniforge/bin/pip install --no-cache-dir \
      https://github.com/eric-d-knowles/rocks-shim/releases/download/0.3.0/rocks_shim-0.3.0-py3-none-manylinux2014_x86_64.manylinux_2_17_x86_64.whl

    # ----------------------------------------------------------------------
    # Cleanup conda & pip caches
    # ----------------------------------------------------------------------
    /opt/miniforge/bin/conda clean -afy
    rm -rf /root/.cache/pip

%environment
    # Use Miniforge Python
    export PATH=/opt/miniforge/bin:$PATH

    # CUDA runtime libraries
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:${LD_LIBRARY_PATH:-}

    # Better Python output behavior
    export PYTHONUNBUFFERED=1

%runscript
    exec /opt/miniforge/bin/python "$@"

%labels
    Author="ngram-kit"
    Version="2.0"
    Description="CUDA 12.6.2 environment with spaCy, simplemma, and rocks_shim for Google Ngrams processing"

%help
    Ngram-Kit Container
    --------------------
    - CUDA 12.6.2 + cuDNN on Ubuntu 22.04
    - Python 3.11 via Miniforge
    - spaCy (+ 7 multilingual models)
    - simplemma (Hebrew + universal lemmatization)
    - gensim, scikit-learn, statsmodels
    - rocks_shim (fast RocksDB access)

    Run with:
      apptainer exec --nv ngram-kit.sif python your_script.py
